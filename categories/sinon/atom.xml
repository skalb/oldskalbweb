<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Sinon | skalb.com]]></title>
  <link href="http://www.skalb.com/categories/sinon/atom.xml" rel="self"/>
  <link href="http://www.skalb.com/"/>
  <updated>2013-07-04T17:13:16-07:00</updated>
  <id>http://www.skalb.com/</id>
  <author>
    <name><![CDATA[Sameer Kalburgi]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Using Sinon Spys with Meteor Collections]]></title>
    <link href="http://www.skalb.com/2012/08/25/using-sinon-spys-with-meteor-collections/"/>
    <updated>2012-08-25T00:00:00-07:00</updated>
    <id>http://www.skalb.com/2012/08/25/using-sinon-spys-with-meteor-collections</id>
    <content type="html"><![CDATA[<p>Following my testing described <a title="Testing Backbone Routers in Meteor with Mocha" href="http://www.skalb.com/2012/08/19/testing-backbone-routers-in-meteor-with-mocha/">here</a>, I wanted to verify that Meteor interacts with my Routers correctly.</p>

<!--more-->


<p>The Meteor.Collection object exposes methods for querying the MongoDB collection as described in the docs. I want to test if my index callback will retrieve all the items it should.</p>

<p>Add the new module we need:</p>

<p><code>bash
npm install sinon
</code></p>

<p>Here's how to use the spy:</p>

<p><code>coffeescript lib/sample_router_factory.coffee
items =
  find: sinon.spy()
</code></p>

<p>Now, let's write our test:</p>

<p><code>coffeescript tests/sample_router_factory_test.coffee
it "should retrieve all items", -&gt;
  router.navigate('', true)
  items.find.called.should.equal true
</code></p>

<p>This will fail, since we need to first modify our Router to accept a collection as an argument and then call find on it.</p>

<p>``` coffeescript lib/sample_router_factory.coffee
root = exports ? this</p>

<p>class SampleRouterFactory
  constructor: (@Backbone, @Items) -></p>

<p>  getRouter: () -></p>

<pre><code>SampleRouter = @Backbone.Router.extend(
  routes:
    "": "index"

  index: =&gt;
    items = @Items.find()
)
new SampleRouter
</code></pre>

<p>root.SampleRouterFactory = SampleRouterFactory
```</p>

<p>This <em>should</em> pass, but yet doesn't. Why? Thinking about the assumption our test is making when using the a Backbone router, it likely depends on Backbone initialization. We can try this in our test, also:</p>

<p><code>coffeescript
Backbone.history.start
  silent: true
  pushState: true
</code></p>

<p>This doesn't work either because Backbone assumes we are in the browser when accessing <strong>window</strong>. I'm pretty sure this is not the approach I want. We don't need to add a dependency on Backbone's internal behavior to test a method of my Router. My previous test verifies that the root path will call an index method, so now I only need to call that index method and validate that behavior. This has the added benefit of simplifying the test.</p>

<p>Here's the final version of my tests:</p>

<p>``` coffeescript tests/sample_router_factory_test.coffee
util = require('util')
should = require('should')
Backbone = require('backbone')
sinon = require('sinon')
SampleRouterFactory = require('../client/lib/sample_router_factory').SampleRouterFactory</p>

<p>describe "SampleRouter", ->
  items =</p>

<pre><code>find: sinon.spy()
</code></pre>

<p>  factory = new SampleRouterFactory(Backbone, items)
  router = factory.getRouter(Backbone)</p>

<p>  it "should have an index route", -></p>

<pre><code>router.routes[''].should.equal('index')
</code></pre>

<p>  it "should retrieve all items when navigating to index", -></p>

<pre><code>router.index()
items.find.called.should.equal true
</code></pre>

<p>```</p>

<p>A bit roundabout, but in the end what I was trying to accomplish. Source <a href="https://github.com/skalb/meteor-examples/tree/master/mocha-router">here</a>.</p>
]]></content>
  </entry>
  
</feed>
